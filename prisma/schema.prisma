// Prisma Schema for Developer System (02)
// نظام المطور - العمود الفقري للتكامل بين جميع الأنظمة

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Developer System Tables (dev_*) ====================

// جدول التكاملات - إدارة التكاملات الداخلية والخارجية
model DevIntegration {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(100)
  nameAr        String?  @map("name_ar") @db.VarChar(100)
  type          String   @db.VarChar(50) // internal, external, iot, payment, sms, email
  baseUrl       String?  @map("base_url") @db.VarChar(500)
  status        String   @default("active") @db.VarChar(20) // active, inactive, error, maintenance
  config        Json?    @db.JsonB
  credentials   Json?    @db.JsonB // encrypted credentials
  healthEndpoint String? @map("health_endpoint") @db.VarChar(500)
  lastHealthCheck DateTime? @map("last_health_check")
  lastHealthStatus String? @map("last_health_status") @db.VarChar(20)
  retryCount    Int      @default(3) @map("retry_count")
  timeout       Int      @default(30000) // milliseconds
  description   String?  @db.Text
  createdBy     String?  @map("created_by") @db.Uuid
  updatedBy     String?  @map("updated_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  apiKeys       DevApiKey[]
  webhooks      DevWebhook[]
  requestLogs   DevRequestLog[]

  @@map("dev_integrations")
  @@index([type])
  @@index([status])
}

// جدول مفاتيح API - إدارة الوصول للأنظمة
model DevApiKey {
  id            String    @id @default(uuid()) @db.Uuid
  integrationId String?   @map("integration_id") @db.Uuid
  systemId      String    @map("system_id") @db.VarChar(50) // core, assets, billing, etc.
  name          String    @db.VarChar(100)
  keyHash       String    @map("key_hash") @db.VarChar(255)
  keyPrefix     String    @map("key_prefix") @db.VarChar(10) // First 8 chars for identification
  permissions   Json      @db.JsonB // Array of allowed endpoints/actions
  rateLimit     Int       @default(1000) @map("rate_limit") // requests per hour
  expiresAt     DateTime? @map("expires_at")
  lastUsedAt    DateTime? @map("last_used_at")
  usageCount    Int       @default(0) @map("usage_count")
  isActive      Boolean   @default(true) @map("is_active")
  ipWhitelist   String[]  @map("ip_whitelist") @db.VarChar(45)
  createdBy     String?   @map("created_by") @db.Uuid
  revokedBy     String?   @map("revoked_by") @db.Uuid
  revokedAt     DateTime? @map("revoked_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  integration   DevIntegration? @relation(fields: [integrationId], references: [id])

  @@map("dev_api_keys")
  @@index([systemId])
  @@index([keyPrefix])
  @@index([isActive])
}

// جدول الأحداث - تسجيل جميع الأحداث في النظام
model DevEvent {
  id            String    @id @default(uuid()) @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100) // customer.created, invoice.paid, meter.reading, etc.
  sourceSystem  String    @map("source_system") @db.VarChar(50)
  targetSystem  String?   @map("target_system") @db.VarChar(50)
  aggregateId   String?   @map("aggregate_id") @db.Uuid // ID of the entity this event relates to
  aggregateType String?   @map("aggregate_type") @db.VarChar(50) // customer, invoice, meter, etc.
  payload       Json      @db.JsonB
  metadata      Json?     @db.JsonB // Additional context (user, ip, etc.)
  status        String    @default("pending") @db.VarChar(20) // pending, processing, completed, failed
  priority      Int       @default(5) // 1-10, 1 is highest
  retryCount    Int       @default(0) @map("retry_count")
  maxRetries    Int       @default(3) @map("max_retries")
  errorMessage  String?   @map("error_message") @db.Text
  processedAt   DateTime? @map("processed_at")
  scheduledFor  DateTime? @map("scheduled_for")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  deliveries    DevEventDelivery[]

  @@map("dev_events")
  @@index([eventType])
  @@index([sourceSystem])
  @@index([status])
  @@index([createdAt])
  @@index([aggregateId])
}

// جدول اشتراكات الأحداث - من يستمع لأي حدث
model DevEventSubscription {
  id            String   @id @default(uuid()) @db.Uuid
  eventType     String   @map("event_type") @db.VarChar(100) // Can use wildcards like "customer.*"
  targetSystem  String   @map("target_system") @db.VarChar(50)
  webhookUrl    String?  @map("webhook_url") @db.VarChar(500)
  httpMethod    String   @default("POST") @map("http_method") @db.VarChar(10)
  headers       Json?    @db.JsonB // Custom headers to send
  secret        String?  @db.VarChar(255) // For HMAC signature
  isActive      Boolean  @default(true) @map("is_active")
  filterRules   Json?    @map("filter_rules") @db.JsonB // Conditions for filtering events
  transformRules Json?   @map("transform_rules") @db.JsonB // Payload transformation
  createdBy     String?  @map("created_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  deliveries    DevEventDelivery[]

  @@map("dev_event_subscriptions")
  @@unique([eventType, targetSystem])
  @@index([eventType])
  @@index([targetSystem])
  @@index([isActive])
}

// جدول تسليم الأحداث - تتبع تسليم كل حدث لكل مشترك
model DevEventDelivery {
  id              String   @id @default(uuid()) @db.Uuid
  eventId         String   @map("event_id") @db.Uuid
  subscriptionId  String   @map("subscription_id") @db.Uuid
  status          String   @default("pending") @db.VarChar(20) // pending, delivered, failed
  attempts        Int      @default(0)
  lastAttemptAt   DateTime? @map("last_attempt_at")
  deliveredAt     DateTime? @map("delivered_at")
  responseCode    Int?     @map("response_code")
  responseBody    String?  @map("response_body") @db.Text
  errorMessage    String?  @map("error_message") @db.Text
  nextRetryAt     DateTime? @map("next_retry_at")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  event           DevEvent @relation(fields: [eventId], references: [id])
  subscription    DevEventSubscription @relation(fields: [subscriptionId], references: [id])

  @@map("dev_event_deliveries")
  @@index([eventId])
  @@index([subscriptionId])
  @@index([status])
}

// جدول Webhooks - إدارة Webhooks للتكاملات الخارجية
model DevWebhook {
  id            String   @id @default(uuid()) @db.Uuid
  integrationId String   @map("integration_id") @db.Uuid
  name          String   @db.VarChar(100)
  url           String   @db.VarChar(500)
  events        String[] @db.VarChar(100) // Array of event types to trigger
  secret        String?  @db.VarChar(255) // For signature verification
  isActive      Boolean  @default(true) @map("is_active")
  headers       Json?    @db.JsonB
  createdBy     String?  @map("created_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  integration   DevIntegration @relation(fields: [integrationId], references: [id])
  logs          DevWebhookLog[]
  deliveries    DevWebhookDelivery[]

  @@map("dev_webhooks")
  @@index([integrationId])
  @@index([isActive])
}

// جدول سجلات Webhooks
model DevWebhookLog {
  id            String   @id @default(uuid()) @db.Uuid
  webhookId     String   @map("webhook_id") @db.Uuid
  eventType     String   @map("event_type") @db.VarChar(100)
  payload       Json     @db.JsonB
  responseCode  Int?     @map("response_code")
  responseBody  String?  @map("response_body") @db.Text
  status        String   @db.VarChar(20) // success, failed, pending
  attempts      Int      @default(1)
  errorMessage  String?  @map("error_message") @db.Text
  duration      Int?     // milliseconds
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  webhook       DevWebhook @relation(fields: [webhookId], references: [id])

  @@map("dev_webhook_logs")
  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
}

// جدول سجلات الطلبات - تسجيل جميع طلبات API
model DevRequestLog {
  id            String   @id @default(uuid()) @db.Uuid
  integrationId String?  @map("integration_id") @db.Uuid
  method        String   @db.VarChar(10) // GET, POST, PUT, DELETE, PATCH
  path          String   @db.VarChar(500)
  sourceSystem  String   @map("source_system") @db.VarChar(50)
  sourceIp      String?  @map("source_ip") @db.VarChar(45)
  userAgent     String?  @map("user_agent") @db.VarChar(500)
  userId        String?  @map("user_id") @db.Uuid
  apiKeyId      String?  @map("api_key_id") @db.Uuid
  requestHeaders Json?   @map("request_headers") @db.JsonB
  requestBody   Json?    @map("request_body") @db.JsonB
  statusCode    Int      @map("status_code")
  responseBody  Json?    @map("response_body") @db.JsonB
  responseTime  Int      @map("response_time") // milliseconds
  errorMessage  String?  @map("error_message") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  integration   DevIntegration? @relation(fields: [integrationId], references: [id])

  @@map("dev_request_logs")
  @@index([sourceSystem])
  @@index([path])
  @@index([statusCode])
  @@index([createdAt])
  @@index([userId])
}

// جدول إعدادات Rate Limiting
model DevRateLimit {
  id            String   @id @default(uuid()) @db.Uuid
  identifier    String   @db.VarChar(255) // API key, IP, or user ID
  identifierType String  @map("identifier_type") @db.VarChar(20) // api_key, ip, user
  endpoint      String?  @db.VarChar(500) // Specific endpoint or null for global
  windowStart   DateTime @map("window_start")
  windowSize    Int      @map("window_size") // seconds
  requestCount  Int      @default(0) @map("request_count")
  maxRequests   Int      @map("max_requests")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("dev_rate_limits")
  @@unique([identifier, identifierType, endpoint, windowStart])
  @@index([identifier])
  @@index([windowStart])
}

// جدول مقاييس النظام - مراقبة الأداء
model DevSystemMetric {
  id            String   @id @default(uuid()) @db.Uuid
  metricName    String   @map("metric_name") @db.VarChar(100)
  metricType    String   @map("metric_type") @db.VarChar(20) // counter, gauge, histogram
  value         Float
  labels        Json?    @db.JsonB // Additional dimensions
  systemId      String?  @map("system_id") @db.VarChar(50)
  timestamp     DateTime @default(now())

  @@map("dev_system_metrics")
  @@index([metricName])
  @@index([systemId])
  @@index([timestamp])
}

// جدول التنبيهات التقنية
model DevAlert {
  id            String   @id @default(uuid()) @db.Uuid
  alertType     String   @map("alert_type") @db.VarChar(50) // error, warning, info, critical
  source        String   @db.VarChar(100) // System or service name
  title         String   @db.VarChar(255)
  message       String   @db.Text
  metadata      Json?    @db.JsonB
  severity      Int      @default(3) // 1-5, 1 is most severe
  status        String   @default("open") @db.VarChar(20) // open, acknowledged, resolved
  acknowledgedBy String? @map("acknowledged_by") @db.Uuid
  acknowledgedAt DateTime? @map("acknowledged_at")
  resolvedBy    String?  @map("resolved_by") @db.Uuid
  resolvedAt    DateTime? @map("resolved_at")
  resolution    String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("dev_alerts")
  @@index([alertType])
  @@index([source])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

// جدول نماذج الذكاء الاصطناعي
model DevAiModel {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(100)
  type          String   @db.VarChar(50) // prediction, anomaly_detection, optimization
  version       String   @db.VarChar(20)
  description   String?  @db.Text
  modelPath     String?  @map("model_path") @db.VarChar(500)
  config        Json?    @db.JsonB
  metrics       Json?    @db.JsonB // accuracy, precision, recall, etc.
  status        String   @default("active") @db.VarChar(20) // active, training, inactive
  lastTrainedAt DateTime? @map("last_trained_at")
  createdBy     String?  @map("created_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  predictions   DevAiPrediction[]

  @@map("dev_ai_models")
  @@index([type])
  @@index([status])
}

// جدول تنبؤات الذكاء الاصطناعي
model DevAiPrediction {
  id            String   @id @default(uuid()) @db.Uuid
  modelId       String   @map("model_id") @db.Uuid
  predictionType String  @map("prediction_type") @db.VarChar(50) // consumption, fault, optimization
  inputData     Json     @map("input_data") @db.JsonB
  outputData    Json     @map("output_data") @db.JsonB
  confidence    Float?   // 0-1
  actualValue   Json?    @map("actual_value") @db.JsonB // For validation
  isCorrect     Boolean? @map("is_correct")
  entityId      String?  @map("entity_id") @db.Uuid // Customer, meter, station, etc.
  entityType    String?  @map("entity_type") @db.VarChar(50)
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  model         DevAiModel @relation(fields: [modelId], references: [id])

  @@map("dev_ai_predictions")
  @@index([modelId])
  @@index([predictionType])
  @@index([entityId])
  @@index([createdAt])
}

// جدول تكاملات بوابات الدفع
model DevPaymentGateway {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(100)
  provider      String   @db.VarChar(50) // stc_pay, mada, stripe, paypal
  apiUrl        String   @map("api_url") @db.VarChar(500)
  credentials   Json     @db.JsonB // Encrypted
  config        Json?    @db.JsonB
  isActive      Boolean  @default(true) @map("is_active")
  isDefault     Boolean  @default(false) @map("is_default")
  supportedCurrencies String[] @map("supported_currencies") @db.VarChar(3)
  fees          Json?    @db.JsonB // Fee structure
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  transactions  DevPaymentTransaction[]

  @@map("dev_payment_gateways")
  @@index([provider])
  @@index([isActive])
}

// جدول معاملات الدفع
model DevPaymentTransaction {
  id              String   @id @default(uuid()) @db.Uuid
  gatewayId       String   @map("gateway_id") @db.Uuid
  externalId      String?  @map("external_id") @db.VarChar(255) // Gateway's transaction ID
  amount          Decimal  @db.Decimal(15, 2)
  currency        String   @db.VarChar(3)
  status          String   @db.VarChar(20) // pending, completed, failed, refunded
  type            String   @db.VarChar(20) // payment, refund, payout
  customerId      String?  @map("customer_id") @db.Uuid
  invoiceId       String?  @map("invoice_id") @db.Uuid
  metadata        Json?    @db.JsonB
  errorCode       String?  @map("error_code") @db.VarChar(50)
  errorMessage    String?  @map("error_message") @db.Text
  gatewayResponse Json?    @map("gateway_response") @db.JsonB
  processedAt     DateTime? @map("processed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  gateway         DevPaymentGateway @relation(fields: [gatewayId], references: [id])

  @@map("dev_payment_transactions")
  @@index([gatewayId])
  @@index([externalId])
  @@index([status])
  @@index([customerId])
  @@index([createdAt])
}

// جدول مزودي الرسائل (SMS, Email, WhatsApp)
model DevMessageProvider {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(100)
  type          String   @db.VarChar(20) // sms, email, whatsapp, push
  provider      String   @db.VarChar(50) // twilio, sendgrid, local_sms, etc.
  apiUrl        String   @map("api_url") @db.VarChar(500)
  credentials   Json     @db.JsonB // Encrypted
  config        Json?    @db.JsonB
  isActive      Boolean  @default(true) @map("is_active")
  isDefault     Boolean  @default(false) @map("is_default")
  priority      Int      @default(1) // For fallback ordering
  sentCount     Int      @default(0) @map("sent_count")
  lastUsedAt    DateTime? @map("last_used_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  messages      DevMessage[]

  @@map("dev_message_providers")
  @@index([type])
  @@index([isActive])
}

// جدول الرسائل المرسلة
model DevMessage {
  id            String   @id @default(uuid()) @db.Uuid
  providerId    String   @map("provider_id") @db.Uuid
  type          String   @db.VarChar(20) // sms, email, whatsapp, push
  recipient     String   @db.VarChar(255) // Phone or email
  subject       String?  @db.VarChar(255) // For email
  body          String   @db.Text
  template      String?  @db.VarChar(100)
  templateData  Json?    @map("template_data") @db.JsonB
  status        String   @default("pending") @db.VarChar(20) // pending, sent, delivered, failed, scheduled
  externalId    String?  @map("external_id") @db.VarChar(255)
  errorMessage  String?  @map("error_message") @db.Text
  sentAt        DateTime? @map("sent_at")
  deliveredAt   DateTime? @map("delivered_at")
  scheduledFor  DateTime? @map("scheduled_for")
  priority      Int      @default(5)
  attempts      Int      @default(0)
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  provider      DevMessageProvider @relation(fields: [providerId], references: [id])

  @@map("dev_messages")
  @@index([providerId])
  @@index([type])
  @@index([status])
  @@index([recipient])
  @@index([createdAt])
}

// جدول أجهزة IoT
model DevIotDevice {
  id              String   @id @default(uuid()) @db.Uuid
  deviceId        String   @unique @map("device_id") @db.VarChar(100) // External device ID
  deviceType      String   @map("device_type") @db.VarChar(50) // meter, sensor, controller
  name            String   @db.VarChar(100)
  nameAr          String?  @map("name_ar") @db.VarChar(100)
  manufacturer    String?  @db.VarChar(100) // acrel, etc.
  model           String?  @db.VarChar(100)
  firmwareVersion String?  @map("firmware_version") @db.VarChar(50)
  location        Json?    @db.JsonB // latitude, longitude, address, zone
  config          Json?    @db.JsonB
  metadata        Json?    @db.JsonB
  status          String   @default("registered") @db.VarChar(20) // registered, active, offline, error, decommissioned
  isOnline        Boolean  @default(false) @map("is_online")
  lastSeenAt      DateTime? @map("last_seen_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  readings        DevIotReading[]
  commands        DevIotCommand[]

  @@map("dev_iot_devices")
  @@index([deviceType])
  @@index([status])
  @@index([isOnline])
}

// جدول قراءات IoT
model DevIotReading {
  id            String   @id @default(uuid()) @db.Uuid
  deviceId      String   @map("device_id") @db.Uuid
  readingType   String   @map("reading_type") @db.VarChar(50) // energy, voltage, current, power_factor
  value         Float
  unit          String   @db.VarChar(20) // kWh, V, A, etc.
  quality       String?  @db.VarChar(20) // good, bad, uncertain
  timestamp     DateTime
  rawData       Json?    @map("raw_data") @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  device        DevIotDevice @relation(fields: [deviceId], references: [id])

  @@map("dev_iot_readings")
  @@index([deviceId])
  @@index([readingType])
  @@index([timestamp])
}

// جدول أوامر IoT
model DevIotCommand {
  id            String   @id @default(uuid()) @db.Uuid
  deviceId      String   @map("device_id") @db.Uuid
  command       String   @db.VarChar(50) // disconnect, reconnect, read, configure
  parameters    Json?    @db.JsonB
  priority      Int      @default(5)
  status        String   @default("pending") @db.VarChar(20) // pending, sent, executed, failed
  expiresAt     DateTime? @map("expires_at")
  executedAt    DateTime? @map("executed_at")
  response      Json?    @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  device        DevIotDevice @relation(fields: [deviceId], references: [id])

  @@map("dev_iot_commands")
  @@index([deviceId])
  @@index([command])
  @@index([status])
  @@index([createdAt])
}

// جدول صحة النظام
model DevSystemHealth {
  id            String   @id @default(uuid()) @db.Uuid
  systemId      String   @map("system_id") @db.VarChar(50)
  status        String   @db.VarChar(20) // healthy, degraded, unhealthy
  uptime        Int?     // seconds
  cpuUsage      Float?   @map("cpu_usage")
  memoryUsage   Float?   @map("memory_usage")
  diskUsage     Float?   @map("disk_usage")
  activeConnections Int? @map("active_connections")
  responseTime  Int?     @map("response_time") // milliseconds
  errorRate     Float?   @map("error_rate") // percentage
  details       Json?    @db.JsonB
  checkedAt     DateTime @map("checked_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_system_health")
  @@index([systemId])
  @@index([status])
  @@index([checkedAt])
}

// جدول سجل التدقيق
model DevAuditLog {
  id            String   @id @default(uuid()) @db.Uuid
  action        String   @db.VarChar(50) // create, update, delete, login, etc.
  entityType    String   @map("entity_type") @db.VarChar(50)
  entityId      String?  @map("entity_id") @db.Uuid
  userId        String?  @map("user_id") @db.Uuid
  userName      String?  @map("user_name") @db.VarChar(100)
  systemId      String?  @map("system_id") @db.VarChar(50)
  oldValues     Json?    @map("old_values") @db.JsonB
  newValues     Json?    @map("new_values") @db.JsonB
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  userAgent     String?  @map("user_agent") @db.VarChar(500)
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_audit_logs")
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([userId])
  @@index([createdAt])
}


// جدول قوالب الرسائل
model DevMessageTemplate {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @unique @db.VarChar(100)
  type          String   @db.VarChar(20) // sms, email, whatsapp, push
  subject       String?  @db.VarChar(255)
  content       String   @db.Text
  variables     String[] @db.VarChar(100)
  isActive      Boolean  @default(true) @map("is_active")
  createdBy     String?  @map("created_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("dev_message_templates")
  @@index([type])
  @@index([isActive])
}

// جدول بيانات IoT
model DevIotData {
  id            String   @id @default(uuid()) @db.Uuid
  deviceId      String   @map("device_id") @db.Uuid
  dataType      String   @map("data_type") @db.VarChar(50)
  value         Json     @db.JsonB
  unit          String?  @db.VarChar(20)
  timestamp     DateTime
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_iot_data")
  @@index([deviceId])
  @@index([dataType])
  @@index([timestamp])
}

// جدول قواعد تنبيهات IoT
model DevIotAlertRule {
  id            String   @id @default(uuid()) @db.Uuid
  deviceId      String?  @map("device_id") @db.Uuid
  deviceType    String?  @map("device_type") @db.VarChar(50)
  dataType      String   @map("data_type") @db.VarChar(50)
  operator      String   @db.VarChar(10) // gt, gte, lt, lte, eq, neq
  threshold     Float
  alertType     String   @map("alert_type") @db.VarChar(50)
  severity      Int      @default(3) // 1-5
  title         String?  @db.VarChar(255)
  message       String?  @db.Text
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  alerts        DevIotAlert[]

  @@map("dev_iot_alert_rules")
  @@index([deviceType])
  @@index([dataType])
  @@index([isActive])
}

// جدول تنبيهات IoT
model DevIotAlert {
  id            String   @id @default(uuid()) @db.Uuid
  deviceId      String   @map("device_id") @db.Uuid
  ruleId        String   @map("rule_id") @db.Uuid
  alertType     String   @map("alert_type") @db.VarChar(50)
  severity      Int
  title         String   @db.VarChar(255)
  message       String   @db.Text
  value         Json     @db.JsonB
  threshold     Float
  status        String   @default("active") @db.VarChar(20) // active, acknowledged, resolved
  acknowledgedBy String? @map("acknowledged_by") @db.Uuid
  acknowledgedAt DateTime? @map("acknowledged_at")
  resolvedAt    DateTime? @map("resolved_at")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  rule          DevIotAlertRule @relation(fields: [ruleId], references: [id])

  @@map("dev_iot_alerts")
  @@index([deviceId])
  @@index([ruleId])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

// جدول طلبات الذكاء الاصطناعي
model DevAiRequest {
  id              String   @id @default(uuid()) @db.Uuid
  requestType     String   @map("request_type") @db.VarChar(50) // analysis, prediction, chat, extraction, sentiment, classification
  model           String   @db.VarChar(50)
  inputTokens     Int      @map("input_tokens")
  outputTokens    Int      @map("output_tokens")
  totalTokens     Int      @map("total_tokens")
  processingTime  Int      @map("processing_time") // milliseconds
  metadata        Json?    @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("dev_ai_requests")
  @@index([requestType])
  @@index([model])
  @@index([createdAt])
}


// ==================== جداول إضافية للمرحلة 1 ====================

// جدول إعدادات التكاملات - تخزين الإعدادات المفصلة لكل تكامل
model DevIntegrationConfig {
  id            String   @id @default(uuid()) @db.Uuid
  integrationId String   @map("integration_id") @db.Uuid
  configKey     String   @map("config_key") @db.VarChar(100)
  configValue   String?  @map("config_value") @db.Text
  isEncrypted   Boolean  @default(false) @map("is_encrypted")
  valueType     String   @default("string") @map("value_type") @db.VarChar(20) // string, number, boolean, json
  environment   String   @default("production") @db.VarChar(20) // production, staging, development
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("dev_integration_configs")
  @@unique([integrationId, configKey, environment])
  @@index([integrationId])
}

// جدول سجلات التكاملات - تتبع جميع طلبات التكامل
model DevIntegrationLog {
  id              String   @id @default(uuid()) @db.Uuid
  integrationId   String   @map("integration_id") @db.Uuid
  requestId       String?  @map("request_id") @db.VarChar(100)
  direction       String   @db.VarChar(10) // outgoing, incoming
  method          String?  @db.VarChar(10) // GET, POST, PUT, DELETE
  endpoint        String?  @db.VarChar(500)
  requestHeaders  Json?    @map("request_headers") @db.JsonB
  requestBody     Json?    @map("request_body") @db.JsonB
  responseStatus  Int?     @map("response_status")
  responseHeaders Json?    @map("response_headers") @db.JsonB
  responseBody    Json?    @map("response_body") @db.JsonB
  durationMs      Int?     @map("duration_ms")
  status          String   @db.VarChar(20) // success, failed, timeout, error
  errorMessage    String?  @map("error_message") @db.Text
  retryCount      Int      @default(0) @map("retry_count")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("dev_integration_logs")
  @@index([integrationId])
  @@index([status])
  @@index([createdAt])
}

// جدول صلاحيات مفاتيح API - تفصيل الصلاحيات
model DevApiKeyPermission {
  id            String   @id @default(uuid()) @db.Uuid
  apiKeyId      String   @map("api_key_id") @db.Uuid
  resource      String   @db.VarChar(100) // integrations, events, webhooks, etc.
  action        String   @db.VarChar(50) // create, read, update, delete, execute
  conditions    Json?    @db.JsonB // Additional conditions
  isAllowed     Boolean  @default(true) @map("is_allowed")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_api_key_permissions")
  @@unique([apiKeyId, resource, action])
  @@index([apiKeyId])
  @@index([resource])
}

// جدول سجلات استخدام API
model DevApiLog {
  id            String   @id @default(uuid()) @db.Uuid
  apiKeyId      String?  @map("api_key_id") @db.Uuid
  endpoint      String   @db.VarChar(500)
  method        String   @db.VarChar(10)
  statusCode    Int      @map("status_code")
  responseTime  Int      @map("response_time") // milliseconds
  requestSize   Int?     @map("request_size") // bytes
  responseSize  Int?     @map("response_size") // bytes
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  userAgent     String?  @map("user_agent") @db.VarChar(500)
  errorMessage  String?  @map("error_message") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_api_logs")
  @@index([apiKeyId])
  @@index([endpoint])
  @@index([statusCode])
  @@index([createdAt])
}

// جدول سجلات معالجة الأحداث
model DevEventLog {
  id              String   @id @default(uuid()) @db.Uuid
  eventId         String   @map("event_id") @db.Uuid
  subscriptionId  String?  @map("subscription_id") @db.Uuid
  processorName   String   @map("processor_name") @db.VarChar(100)
  status          String   @db.VarChar(20) // pending, processing, success, failed
  attemptNumber   Int      @default(1) @map("attempt_number")
  response        Json?    @db.JsonB
  errorMessage    String?  @map("error_message") @db.Text
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  durationMs      Int?     @map("duration_ms")
  nextRetryAt     DateTime? @map("next_retry_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("dev_event_logs")
  @@index([eventId])
  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
}

// جدول سجلات النظام - تسجيل جميع أنشطة النظام
model DevSystemLog {
  id            String   @id @default(uuid()) @db.Uuid
  level         String   @db.VarChar(20) // debug, info, warn, error, fatal
  source        String   @db.VarChar(100) // Service or module name
  message       String   @db.Text
  context       Json?    @db.JsonB // Additional context data
  traceId       String?  @map("trace_id") @db.VarChar(100)
  spanId        String?  @map("span_id") @db.VarChar(100)
  userId        String?  @map("user_id") @db.Uuid
  systemId      String?  @map("system_id") @db.VarChar(50)
  errorStack    String?  @map("error_stack") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_system_logs")
  @@index([level])
  @@index([source])
  @@index([traceId])
  @@index([createdAt])
}

// جدول قواعد التنبيهات - تعريف متى يتم إنشاء تنبيه
model DevAlertRule {
  id                String   @id @default(uuid()) @db.Uuid
  name              String   @db.VarChar(200)
  description       String?  @db.Text
  conditionType     String   @map("condition_type") @db.VarChar(50) // threshold, anomaly, pattern
  conditionConfig   Json     @map("condition_config") @db.JsonB
  alertType         String   @map("alert_type") @db.VarChar(50)
  severity          Int      @default(3) // 1-5
  titleTemplate     String   @map("title_template") @db.VarChar(500)
  descriptionTemplate String? @map("description_template") @db.Text
  actions           Json     @default("[]") @db.JsonB // email, sms, webhook
  isActive          Boolean  @default(true) @map("is_active")
  cooldownMinutes   Int      @default(15) @map("cooldown_minutes")
  lastTriggeredAt   DateTime? @map("last_triggered_at")
  createdBy         String?  @map("created_by") @db.Uuid
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("dev_alert_rules")
  @@index([alertType])
  @@index([isActive])
}

// جدول بيانات تدريب الذكاء الاصطناعي
model DevAiTrainingData {
  id              String   @id @default(uuid()) @db.Uuid
  modelType       String   @map("model_type") @db.VarChar(50)
  featureData     Json     @map("feature_data") @db.JsonB
  labelData       Json?    @map("label_data") @db.JsonB
  sourceSystem    String?  @map("source_system") @db.VarChar(50)
  sourceEntityType String? @map("source_entity_type") @db.VarChar(50)
  sourceEntityId  String?  @map("source_entity_id") @db.Uuid
  qualityScore    Float?   @map("quality_score")
  isValidated     Boolean  @default(false) @map("is_validated")
  dataTimestamp   DateTime? @map("data_timestamp")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("dev_ai_training_data")
  @@index([modelType])
  @@index([dataTimestamp])
}

// جدول جلسات المحادثة مع الذكاء الاصطناعي
model DevAiChatSession {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String?  @map("user_id") @db.Uuid
  title         String?  @db.VarChar(255)
  context       Json?    @db.JsonB // Session context
  status        String   @default("active") @db.VarChar(20) // active, closed
  messageCount  Int      @default(0) @map("message_count")
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  messages      DevAiChatMessage[]

  @@map("dev_ai_chat_sessions")
  @@index([userId])
  @@index([status])
}

// جدول رسائل المحادثة
model DevAiChatMessage {
  id            String   @id @default(uuid()) @db.Uuid
  sessionId     String   @map("session_id") @db.Uuid
  role          String   @db.VarChar(20) // user, assistant, system
  content       String   @db.Text
  tokens        Int?
  metadata      Json?    @db.JsonB
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  session       DevAiChatSession @relation(fields: [sessionId], references: [id])

  @@map("dev_ai_chat_messages")
  @@index([sessionId])
  @@index([createdAt])
}

// جدول إعدادات النظام العامة
model DevSystemSetting {
  id            String   @id @default(uuid()) @db.Uuid
  category      String   @db.VarChar(50) // general, security, integration, ai, monitoring
  key           String   @db.VarChar(100)
  value         String   @db.Text
  valueType     String   @default("string") @map("value_type") @db.VarChar(20)
  description   String?  @db.Text
  isEncrypted   Boolean  @default(false) @map("is_encrypted")
  isEditable    Boolean  @default(true) @map("is_editable")
  updatedBy     String?  @map("updated_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("dev_system_settings")
  @@unique([category, key])
  @@index([category])
}

// جدول المهام المجدولة
model DevScheduledTask {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(100)
  description   String?  @db.Text
  taskType      String   @map("task_type") @db.VarChar(50) // cron, interval, once
  schedule      String?  @db.VarChar(100) // Cron expression or interval
  handler       String   @db.VarChar(200) // Handler function/service
  parameters    Json?    @db.JsonB
  isActive      Boolean  @default(true) @map("is_active")
  lastRunAt     DateTime? @map("last_run_at")
  lastRunStatus String?  @map("last_run_status") @db.VarChar(20)
  nextRunAt     DateTime? @map("next_run_at")
  runCount      Int      @default(0) @map("run_count")
  failCount     Int      @default(0) @map("fail_count")
  createdBy     String?  @map("created_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  logs          DevScheduledTaskLog[]

  @@map("dev_scheduled_tasks")
  @@index([taskType])
  @@index([isActive])
  @@index([nextRunAt])
}

// جدول سجلات المهام المجدولة
model DevScheduledTaskLog {
  id            String   @id @default(uuid()) @db.Uuid
  taskId        String   @map("task_id") @db.Uuid
  status        String   @db.VarChar(20) // running, success, failed
  startedAt     DateTime @map("started_at")
  completedAt   DateTime? @map("completed_at")
  durationMs    Int?     @map("duration_ms")
  result        Json?    @db.JsonB
  errorMessage  String?  @map("error_message") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  task          DevScheduledTask @relation(fields: [taskId], references: [id])

  @@map("dev_scheduled_task_logs")
  @@index([taskId])
  @@index([status])
  @@index([startedAt])
}

// جدول طوابير المهام - للمعالجة غير المتزامنة
model DevJobQueue {
  id            String   @id @default(uuid()) @db.Uuid
  queueName     String   @map("queue_name") @db.VarChar(100)
  jobType       String   @map("job_type") @db.VarChar(100)
  payload       Json     @db.JsonB
  priority      Int      @default(5)
  status        String   @default("pending") @db.VarChar(20) // pending, processing, completed, failed, cancelled
  attempts      Int      @default(0)
  maxAttempts   Int      @default(3) @map("max_attempts")
  errorMessage  String?  @map("error_message") @db.Text
  result        Json?    @db.JsonB
  scheduledFor  DateTime? @map("scheduled_for")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_job_queue")
  @@index([queueName])
  @@index([jobType])
  @@index([status])
  @@index([priority])
  @@index([scheduledFor])
}


// جدول Dead Letter Queue - للأحداث والـ Webhooks الفاشلة
model DevDeadLetterQueue {
  id            String   @id @default(uuid()) @db.Uuid
  type          String   @db.VarChar(50) // webhook, event, job
  originalId    String   @map("original_id") @db.VarChar(100)
  originalData  Json?    @map("original_data") @db.JsonB
  reason        String   @db.Text
  attemptCount  Int      @default(0) @map("attempt_count")
  lastError     String?  @map("last_error") @db.Text
  status        String   @default("pending") @db.VarChar(20) // pending, reprocessed, discarded
  reprocessedAt DateTime? @map("reprocessed_at")
  discardedAt   DateTime? @map("discarded_at")
  discardedBy   String?  @map("discarded_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("dev_dead_letter_queue")
  @@index([type])
  @@index([status])
  @@index([createdAt])
}


// جدول سجلات الوصول - Access Logs
model DevAccessLog {
  id            String   @id @default(uuid()) @db.Uuid
  method        String   @db.VarChar(10)
  path          String   @db.VarChar(500)
  statusCode    Int      @map("status_code")
  responseTime  Int      @map("response_time") // milliseconds
  requestSize   Int?     @map("request_size") // bytes
  responseSize  Int?     @map("response_size") // bytes
  userId        String?  @map("user_id") @db.Uuid
  apiKeyId      String?  @map("api_key_id") @db.Uuid
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  userAgent     String?  @map("user_agent") @db.VarChar(500)
  referer       String?  @db.VarChar(500)
  requestId     String?  @map("request_id") @db.VarChar(100)
  errorMessage  String?  @map("error_message") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_access_logs")
  @@index([method])
  @@index([path])
  @@index([statusCode])
  @@index([userId])
  @@index([createdAt])
}

// جدول سجلات الأخطاء - Error Logs
model DevErrorLog {
  id            String   @id @default(uuid()) @db.Uuid
  level         String   @db.VarChar(20) // error, fatal, critical
  source        String   @db.VarChar(100)
  message       String   @db.Text
  stack         String?  @db.Text
  context       Json?    @db.JsonB
  requestId     String?  @map("request_id") @db.VarChar(100)
  userId        String?  @map("user_id") @db.Uuid
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  resolved      Boolean  @default(false)
  resolvedAt    DateTime? @map("resolved_at")
  resolvedBy    String?  @map("resolved_by") @db.Uuid
  resolution    String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_error_logs")
  @@index([level])
  @@index([source])
  @@index([resolved])
  @@index([createdAt])
}

// جدول سجلات الأداء - Performance Logs
model DevPerformanceLog {
  id            String   @id @default(uuid()) @db.Uuid
  metricName    String   @map("metric_name") @db.VarChar(100)
  metricType    String   @map("metric_type") @db.VarChar(50) // counter, gauge, histogram, summary
  value         Float
  unit          String?  @db.VarChar(20) // ms, bytes, percent, count
  tags          Json?    @db.JsonB // Additional dimensions
  source        String?  @db.VarChar(100)
  timestamp     DateTime @default(now())
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("dev_performance_logs")
  @@index([metricName])
  @@index([metricType])
  @@index([timestamp])
}


// جدول تسليم Webhooks - تتبع تسليم كل webhook
model DevWebhookDelivery {
  id            String   @id @default(uuid()) @db.Uuid
  webhookId     String   @map("webhook_id") @db.Uuid
  eventId       String   @map("event_id") @db.VarChar(100)
  url           String   @db.VarChar(500)
  payload       Json     @db.JsonB
  status        String   @default("pending") @db.VarChar(20) // pending, success, failed
  statusCode    Int?     @map("status_code")
  response      String?  @db.Text
  error         String?  @db.Text
  attemptCount  Int      @default(0) @map("attempt_count")
  nextRetryAt   DateTime? @map("next_retry_at")
  deliveredAt   DateTime? @map("delivered_at")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  webhook       DevWebhook @relation(fields: [webhookId], references: [id])

  @@map("dev_webhook_deliveries")
  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
}
